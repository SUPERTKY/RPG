<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚·ãƒ¼ãƒ³2</title>
  <link rel="stylesheet" href="scene2.css">
  <link rel="icon" href="assets/favicon.png" type="image/png">

</head>

<body>
  <div id="fade-overlay"></div>
  <div id="content">
    <h1>ã“ã‚Œã¯ã‚·ãƒ¼ãƒ³2ã§ã™</h1>
  </div>
<img id="back-button" src="assets/back-button.png" alt="æˆ»ã‚‹">

  <audio id="bgm" src="assets/ã®ã©ã‹ãªæ‘ã§_2.mp3" autoplay loop></audio>
  <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ -->
<img id="create-room-button" src="assets/ã‚¯ãƒªã‚¨ã‚¤ãƒˆãƒ«ãƒ¼ãƒ .png" alt="Create Room">
<div id="rpg-frame">
  <div id="room-info">ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<style>
  #rpg-frame {
    background-image: url("assets/frame.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    width: 400px;
    height: 400px;
    padding: 40px;
    font-family: 'serif';
    color: #4b2e12;
    overflow-y: auto;
    white-space: pre-line;
    margin: auto;
  }
</style>


<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼šãƒ«ãƒ¼ãƒ ä½œæˆ + é›¢è„±æ™‚å‰Šé™¤ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, get, set, child, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA7SXxjTK4OIRttEwJ1sDSgaXs45eZQcPQ",
    authDomain: "myrpggame-5eba1.firebaseapp.com",
    projectId: "myrpggame-5eba1",
    storageBucket: "myrpggame-5eba1.appspot.com",
    messagingSenderId: "283723511502",
    appId: "1:283723511502:web:4e5014928190c3a4e0829f",
    databaseURL: "https://myrpggame-5eba1-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const button = document.getElementById("create-room-button");
  let myRoomRef = null;

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ«ãƒ¼ãƒ ç•ªå·ç”Ÿæˆ
  async function generateUniqueRoomNumber() {
    const dbRef = ref(db, "rooms");
    let roomNumber;
    let exists = true;

    while (exists) {
      roomNumber = Math.floor(1000 + Math.random() * 9000).toString();
      const snapshot = await get(child(dbRef, roomNumber));
      exists = snapshot.exists();
    }

    return roomNumber;
  }

button.addEventListener("click", async () => {
  button.style.pointerEvents = "none";
  button.style.opacity = 0.5;

  const playerName = localStorage.getItem("playerName");
  const userId = localStorage.getItem("userId");

  if (!playerName || !userId) {
    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
    console.warn("âŒ localStorageã«playerNameã¾ãŸã¯userIdãŒå­˜åœ¨ã—ã¾ã›ã‚“");
    button.style.pointerEvents = "auto";
    button.style.opacity = 1;
    return;
  }

  try {
    const roomNumber = await generateUniqueRoomNumber();
    const roomRef = ref(db, `rooms/${roomNumber}`);

    console.log("ğŸ’¾ Firebaseã¸ãƒ«ãƒ¼ãƒ ä¿å­˜:", roomNumber);

    // Firebaseã«ä¿å­˜
    await set(roomRef, {
      info: {
        host: playerName,
        createdAt: Date.now()
      },
      members: {
        [playerName]: {
          userId: userId,
          joinedAt: Date.now()
        }
      }
    });

    // æˆåŠŸç¢ºèª
    const confirm = await get(roomRef);
    if (!confirm.exists()) {
      throw new Error("âš ï¸ Firebaseã«ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆä¿å­˜å¤±æ•—ï¼‰");
    }

    myRoomRef = roomRef;
    alert(`âœ… ãƒ«ãƒ¼ãƒ  ${roomNumber} ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);

    // âœ… è¡¨ç¤ºå‡¦ç†
    const data = confirm.val();
    const info = data.info;
    const members = data.members || {};
    const display =
      `ä¸»å‚¬è€…: ${info?.host || "???"}\n` +
      `ç•ªå·: ${roomNumber}\n` +
      `ãƒ¡ãƒ³ãƒãƒ¼:\n` +
      Object.keys(members)
        .map(name => `ãƒ»${name}`)
        .join("\n");

    document.getElementById("room-info").innerText = display;

  } catch (err) {
    console.error("âŒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
    alert("âŒ ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼");
    button.style.pointerEvents = "auto";
    button.style.opacity = 1;
  }
});

  // é›¢è„±æ™‚ã«ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦ãƒ›ãƒ¼ãƒ ã¸æˆ»ã™
  window.addEventListener("beforeunload", async () => {
    if (myRoomRef) {
      try {
        await remove(myRoomRef);
        console.log("âœ… ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
      } catch (e) {
        console.warn("âš ï¸ ãƒ«ãƒ¼ãƒ å‰Šé™¤å¤±æ•—:", e);
      }
    }
  });
document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "hidden" && myRoomRef) {
    try {
      await remove(myRoomRef);
      console.log("âœ… visibilitychangeã§ãƒ«ãƒ¼ãƒ å‰Šé™¤");
    } catch (e) {
      console.warn("âš ï¸ visibilitychangeå‰Šé™¤å¤±æ•—:", e);
    }
  }
  
});
// ã‚¿ãƒ–ãŒéè¡¨ç¤ºã«ãªã£ãŸã¨ãã«ãƒ›ãƒ¼ãƒ ã¸å¼·åˆ¶ç§»å‹•ã™ã‚‹æº–å‚™
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    // 2ç§’å¾Œã«è‡ªå‹•ã§ index.html ã¸æˆ»ã™
    setTimeout(() => {
      window.location.href = "index.html";
    });
  }
});

</script>


  <!-- âœ… script ã¯ä¸€ç•ªæœ€å¾Œ -->
  <script src="scene2.js"></script>
</body>
</html>
