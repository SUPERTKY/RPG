<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Ç∑„Éº„É≥2</title>
  <link rel="stylesheet" href="scene2.css">
  <link rel="icon" href="assets/favicon.png" type="image/png">

</head>

<body>
  <div id="fade-overlay"></div>
  <div id="content">
    <h1>„Åì„Çå„ÅØ„Ç∑„Éº„É≥2„Åß„Åô</h1>
  </div>
<img id="back-button" src="assets/back-button.png" alt="Êàª„Çã">

  <audio id="bgm" src="assets/„ÅÆ„Å©„Åã„Å™Êùë„Åß_2.mp3" autoplay loop></audio>
  <!-- „É´„Éº„É†‰ΩúÊàê„Éú„Çø„É≥ -->
<img id="create-room-button" src="assets/„ÇØ„É™„Ç®„Ç§„Éà„É´„Éº„É†.png" alt="Create Room">


<!-- „Çπ„ÇØ„É™„Éó„ÉàÔºö„É´„Éº„É†‰ΩúÊàê + Èõ¢ËÑ±ÊôÇÂâäÈô§ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, get, set, child, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA7SXxjTK4OIRttEwJ1sDSgaXs45eZQcPQ",
    authDomain: "myrpggame-5eba1.firebaseapp.com",
    projectId: "myrpggame-5eba1",
    storageBucket: "myrpggame-5eba1.appspot.com",
    messagingSenderId: "283723511502",
    appId: "1:283723511502:web:4e5014928190c3a4e0829f",
    databaseURL: "https://myrpggame-5eba1-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const button = document.getElementById("create-room-button");
  let myRoomRef = null;

  // „É¶„Éã„Éº„ÇØ„Å™„É´„Éº„É†Áï™Âè∑ÁîüÊàê
  async function generateUniqueRoomNumber() {
    const dbRef = ref(db, "rooms");
    let roomNumber;
    let exists = true;

    while (exists) {
      roomNumber = Math.floor(1000 + Math.random() * 9000).toString();
      const snapshot = await get(child(dbRef, roomNumber));
      exists = snapshot.exists();
    }

    return roomNumber;
  }

  // „Éú„Çø„É≥Êäº„Åï„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
  button.addEventListener("click", async () => {
    button.style.pointerEvents = "none";
    button.style.opacity = 0.5;

   try {
  const roomNumber = await generateUniqueRoomNumber();
  const roomRef = ref(db, `rooms/${roomNumber}`);

  console.log("üíæ „É´„Éº„É†„ÇíÊõ∏„ÅçËæº„Åø‰∏≠: ", roomNumber);

  await set(roomRef, {
    createdAt: Date.now(),
    status: "waiting"
  });

  // ÊàêÂäü„Åó„Åü„ÅãÁ¢∫Ë™ç
  const confirm = await get(roomRef);
  if (!confirm.exists()) {
    throw new Error("‚ö†Ô∏è „É´„Éº„É†„ÅåFirebase‰∏ä„Å´Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºà‰øùÂ≠òÂ§±ÊïóÔºâ");
  }

  console.log("‚úÖ Firebase‰∏ä„Å´„É´„Éº„É†‰ΩúÊàêÂÆå‰∫Ü");
  myRoomRef = roomRef;
  alert(`‚úÖ „É´„Éº„É† ${roomNumber} „Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ`);

} catch (err) {
  console.error("‚ùå ‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº:", err);
  alert("‚ùå „É´„Éº„É†‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºÅ");
  button.style.pointerEvents = "auto";
  button.style.opacity = 1;
}

  });
  // Èõ¢ËÑ±ÊôÇ„Å´„É´„Éº„É†„ÇíÂâäÈô§„Åó„Å¶„Éõ„Éº„É†„Å∏Êàª„Åô
  window.addEventListener("beforeunload", async () => {
    if (myRoomRef) {
      try {
        await remove(myRoomRef);
        console.log("‚úÖ „É´„Éº„É†„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");
      } catch (e) {
        console.warn("‚ö†Ô∏è „É´„Éº„É†ÂâäÈô§Â§±Êïó:", e);
      }
    }
  });
document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "hidden" && myRoomRef) {
    try {
      await remove(myRoomRef);
      console.log("‚úÖ visibilitychange„Åß„É´„Éº„É†ÂâäÈô§");
    } catch (e) {
      console.warn("‚ö†Ô∏è visibilitychangeÂâäÈô§Â§±Êïó:", e);
    }
  }
  
});
// „Çø„Éñ„ÅåÈùûË°®Á§∫„Å´„Å™„Å£„Åü„Å®„Åç„Å´„Éõ„Éº„É†„Å∏Âº∑Âà∂ÁßªÂãï„Åô„ÇãÊ∫ñÂÇô
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    // 2ÁßíÂæå„Å´Ëá™Âãï„Åß index.html „Å∏Êàª„Åô
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  }
});

</script>


  <!-- ‚úÖ script „ÅØ‰∏ÄÁï™ÊúÄÂæå -->
  <script src="scene2.js"></script>
</body>
</html>
