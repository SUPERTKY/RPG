<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>シーン2</title>
  <link rel="stylesheet" href="scene2.css">
</head>

<body>
  <div id="fade-overlay"></div>
  <div id="content">
    <h1>これはシーン2です</h1>
  </div>
<img id="back-button" src="assets/back-button.png" alt="戻る">

  <audio id="bgm" src="assets/のどかな村で_2.mp3" autoplay loop></audio>
  <!-- ルーム作成ボタン -->
<img id="create-room-button" src="assets/クリエイトルーム.png" alt="Create Room">


<!-- スクリプト：ルーム作成 + 離脱時削除 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, get, set, child, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA7SXxjTK4OIRttEwJ1sDSgaXs45eZQcPQ",
    authDomain: "myrpggame-5eba1.firebaseapp.com",
    projectId: "myrpggame-5eba1",
    storageBucket: "myrpggame-5eba1.appspot.com",
    messagingSenderId: "283723511502",
    appId: "1:283723511502:web:4e5014928190c3a4e0829f",
    databaseURL: "https://myrpggame-5eba1-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const button = document.getElementById("create-room-button");
  let myRoomRef = null;

  // ユニークなルーム番号生成
  async function generateUniqueRoomNumber() {
    const dbRef = ref(db, "rooms");
    let roomNumber;
    let exists = true;

    while (exists) {
      roomNumber = Math.floor(1000 + Math.random() * 9000).toString();
      const snapshot = await get(child(dbRef, roomNumber));
      exists = snapshot.exists();
    }

    return roomNumber;
  }

  // ボタン押されたときの処理
  button.addEventListener("click", async () => {
    button.style.pointerEvents = "none";
    button.style.opacity = 0.5;

    try {
      const roomNumber = await generateUniqueRoomNumber();
      const roomRef = ref(db, `rooms/${roomNumber}`);

      await set(roomRef, {
        createdAt: Date.now(),
        status: "waiting"
      });

      const confirm = await get(roomRef);
      if (!confirm.exists()) {
        throw new Error("ルーム作成失敗");
      }

      myRoomRef = roomRef;
      alert(`✅ ルーム ${roomNumber} が作成されました！`);

    } catch (err) {
      console.error("エラー:", err);
      alert("❌ ルーム作成に失敗しました！");
      button.style.pointerEvents = "auto";
      button.style.opacity = 1;
    }
  });

document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "hidden" && myRoomRef) {
    try {
      await remove(myRoomRef);
      console.log("✅ visibilitychangeでルーム削除");
    } catch (e) {
      console.warn("⚠️ visibilitychange削除失敗:", e);
    }
  }
});

</script>


  <!-- ✅ script は一番最後 -->
  <script src="scene2.js"></script>
</body>
</html>
