
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚·ãƒ¼ãƒ³2</title>
  <link rel="stylesheet" href="scene2.css">
  <link rel="icon" href="assets/favicon.png" type="image/png">

</head>

<body>
  <div id="fade-overlay"></div>
  <div id="content">
    <h1>ã“ã‚Œã¯ã‚·ãƒ¼ãƒ³2ã§ã™</h1>
  </div>
<img id="back-button" src="assets/back-button.png" alt="æˆ»ã‚‹">

  <audio id="bgm" src="assets/ã®ã©ã‹ãªæ‘ã§_2.mp3" autoplay loop></audio>
  <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ -->
<img id="create-room-button" src="assets/ã‚¯ãƒªã‚¨ã‚¤ãƒˆãƒ«ãƒ¼ãƒ .png" alt="Create Room">
  <!-- JOIN ãƒœã‚¿ãƒ³ -->
<img id="join-room-button" src="assets/ã‚¸ãƒ§ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ .png" alt="Join Room" style="display: block; margin: 10px auto; cursor: pointer;">

<!-- å…¥åŠ›UIï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
<div id="join-ui" style="display: none; text-align: center; margin-top: 10px;">
  <div style="
    background-image: url('assets/input-frame.png');
    background-size: 100% 100%;
    width: 200px;
    height: 50px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
  ">
    <input id="join-room-number" type="text" maxlength="4" placeholder="ç•ªå·" style="
      border: none;
      background: transparent;
      width: 80%;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      outline: none;
    ">
  </div>
  <button id="submit-join" style="margin-top: 10px; padding: 5px 15px; font-weight: bold; cursor: pointer;">å‚åŠ </button>
</div>

<!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ & åŠ¹æœéŸ³ -->
<div id="join-error" style="
  display: none;
  color: red;
  font-weight: bold;
  text-align: center;
  margin-top: 10px;
  opacity: 1;
  transition: opacity 2s ease-out;
">ãªã„ã§ã™</div>
<audio id="error-sound" src="assets/ç ´æ»…ãƒ»å£Šæ»…çš„ãªãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆéŸ³.mp3"></audio>

<div id="rpg-frame">
  <div id="room-info">ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>
  <style>
#rpg-frame {
  background-image: url("assets/æœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ .png");
  background-size: 100% 100%;
  background-repeat: no-repeat;
  background-position: center;
  width: 300px;
  height: 250px;

  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 9998;

  display: flex;
  align-items: center;     /* âœ… ç¸¦ä¸­å¤® */
  justify-content: center; /* âœ… æ¨ªä¸­å¤® */
  text-align: center;

  font-family: 'serif';
  font-size: 14px;
  font-weight: bold;
  color: #4b2e12;
  padding: 20px;
  box-sizing: border-box;

  overflow: hidden;
}

  #room-info {
    font-size: 14px;
    line-height: 1.6;
  }
</style>


<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼šãƒ«ãƒ¼ãƒ ä½œæˆ + é›¢è„±æ™‚å‰Šé™¤ -->
<script type="module">
  const currentRoom = localStorage.getItem("currentRoom");
  const joinButton = document.getElementById("join-room-button");
if (currentRoom) {
  const createBtn = document.getElementById("create-room-button");
  const joinBtn = document.getElementById("join-room-button");

  if (createBtn) {
    createBtn.style.opacity = 0.4;
    createBtn.style.pointerEvents = "none";
  }

  if (joinBtn) {
    joinBtn.style.opacity = 0.4;
    joinBtn.style.pointerEvents = "none";
  }

  console.log(`ğŸ›‘ ãƒ«ãƒ¼ãƒ (${currentRoom})ã«å…¥ã£ã¦ã„ã‚‹ã®ã§ä½œæˆãƒ»å‚åŠ ãƒœã‚¿ãƒ³ã‚’å°ã˜ã¾ã—ãŸ`);
}


  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, get, set, child, remove, onValue  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA7SXxjTK4OIRttEwJ1sDSgaXs45eZQcPQ",
    authDomain: "myrpggame-5eba1.firebaseapp.com",
    projectId: "myrpggame-5eba1",
    storageBucket: "myrpggame-5eba1.appspot.com",
    messagingSenderId: "283723511502",
    appId: "1:283723511502:web:4e5014928190c3a4e0829f",
    databaseURL: "https://myrpggame-5eba1-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
    const playerName = localStorage.getItem("playerName");
  const userId = localStorage.getItem("userId");
  const button = document.getElementById("create-room-button");
  let myRoomRef = null;

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ«ãƒ¼ãƒ ç•ªå·ç”Ÿæˆ
  async function generateUniqueRoomNumber() {
    const dbRef = ref(db, "rooms");
    let roomNumber;
    let exists = true;

    while (exists) {
      roomNumber = Math.floor(1000 + Math.random() * 9000).toString();
      const snapshot = await get(child(dbRef, roomNumber));
      exists = snapshot.exists();
    }

    return roomNumber;
  }

let isCreating = false; // ğŸ”’ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸Šã®æ–¹ã«1å›ã ã‘å®šç¾©ã—ã¦ãŠãï¼

button.addEventListener("click", async () => {
  if (isCreating) return; // âœ… ã™ã§ã«ä½œæˆä¸­ãªã‚‰ç„¡è¦–
  isCreating = true;      // âœ… ãƒ­ãƒƒã‚¯ã‚’ã‹ã‘ã‚‹

  const joinBtn = document.getElementById("join-room-button");
  button.style.pointerEvents = "none";
  button.style.opacity = 0.5;
  joinBtn.style.pointerEvents = "none";
  joinBtn.style.opacity = 0.5;

  const playerName = localStorage.getItem("playerName");
  const userId = localStorage.getItem("userId");

  if (!playerName || !userId) {
    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
    console.warn("âŒ localStorageã«playerNameã¾ãŸã¯userIdãŒå­˜åœ¨ã—ã¾ã›ã‚“");
    button.style.pointerEvents = "auto";
    button.style.opacity = 1;
    joinBtn.style.pointerEvents = "auto";
    joinBtn.style.opacity = 1;
    isCreating = false; // âŒå¤±æ•—æ™‚ã«ã‚‚ãƒ­ãƒƒã‚¯ã‚’å¤–ã™ï¼
    return;
  }

  try {
    const roomNumber = await generateUniqueRoomNumber();
    const roomRef = ref(db, `rooms/${roomNumber}`);

    console.log("ğŸ’¾ Firebaseã¸ãƒ«ãƒ¼ãƒ ä¿å­˜:", roomNumber);

    await set(roomRef, {
      info: {
        host: playerName,
        createdAt: Date.now()
      },
      members: {
        [playerName]: {
          userId: userId,
          joinedAt: Date.now()
        }
      }
    });

    const confirm = await get(roomRef);
    if (!confirm.exists()) {
      throw new Error("âš ï¸ Firebaseã«ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆä¿å­˜å¤±æ•—ï¼‰");
    }

    const data = confirm.val();
    const info = data.info;
    const members = data.members || {};
    const display =
      `ä¸»å‚¬è€…: ${info?.host || "???"}\n` +
      `ç•ªå·: ${roomNumber}\n` +
      `ãƒ¡ãƒ³ãƒãƒ¼:\n` +
      Object.keys(members).map(name => `ãƒ»${name}`).join("\n");

    const infoBox = document.getElementById("room-info");
    if (infoBox) infoBox.innerText = display;

    myRoomRef = roomRef;
    alert(`âœ… ãƒ«ãƒ¼ãƒ  ${roomNumber} ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);

    localStorage.setItem("currentRoom", roomNumber); // âœ… çŠ¶æ…‹ã‚‚ä¿å­˜ã—ã¦ãŠã
    startRoomInfoListener(roomNumber); // ğŸ” ã“ã‚Œã‚’è¿½åŠ ï¼

  } catch (err) {
    console.error("âŒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
    alert("âŒ ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼");
    button.style.pointerEvents = "auto";
    button.style.opacity = 1;
    joinBtn.style.pointerEvents = "auto";
    joinBtn.style.opacity = 1;
  } finally {
    isCreating = false; // âœ… æˆåŠŸã§ã‚‚å¤±æ•—ã§ã‚‚ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
  }
});

window.addEventListener("beforeunload", async () => {
  const currentRoom = localStorage.getItem("currentRoom");
  const playerName = localStorage.getItem("playerName");
  const userId = localStorage.getItem("userId");

  if (currentRoom && playerName) {
    const roomRef = ref(db, `rooms/${currentRoom}`);

    try {
      const snapshot = await get(roomRef);
      const host = snapshot.val()?.info?.host;

      // è‡ªåˆ†ãŒä¸»å‚¬è€…ã ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ ã”ã¨å‰Šé™¤
      if (host === playerName) {
        await remove(roomRef);
        console.log("âœ… ä¸»å‚¬è€…ãªã®ã§ãƒ«ãƒ¼ãƒ å…¨ä½“ã‚’å‰Šé™¤");
      } else {
        // å‚åŠ è€…ãªã‚‰ members ã®ã¿å‰Šé™¤
        await remove(ref(db, `rooms/${currentRoom}/members/${playerName}`));
        console.log("âœ… å‚åŠ è€…ãªã®ã§è‡ªåˆ†ã ã‘ members ã‹ã‚‰å‰Šé™¤");
      }

      localStorage.removeItem("currentRoom");
    } catch (e) {
      console.warn("âš ï¸ é›¢è„±æ™‚ã®å‰Šé™¤å¤±æ•—:", e);
    }
  }
});

document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "hidden" && myRoomRef) {
    try {
      await remove(myRoomRef);
      console.log("âœ… visibilitychangeã§ãƒ«ãƒ¼ãƒ å‰Šé™¤");
    } catch (e) {
      console.warn("âš ï¸ visibilitychangeå‰Šé™¤å¤±æ•—:", e);
    }
  }
  
});
document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "hidden") {
    const currentRoom = localStorage.getItem("currentRoom");
    const playerName = localStorage.getItem("playerName");

    if (currentRoom && playerName) {
      const roomRef = ref(db, `rooms/${currentRoom}`);

      try {
        const snapshot = await get(roomRef);
        const host = snapshot.val()?.info?.host;

        if (host === playerName) {
          await remove(roomRef);
          console.log("âœ… visibilitychange: ä¸»å‚¬è€…ãªã®ã§ãƒ«ãƒ¼ãƒ å‰Šé™¤");
        } else {
          await remove(ref(db, `rooms/${currentRoom}/members/${playerName}`));
          console.log("âœ… visibilitychange: å‚åŠ è€…ãªã®ã§ members ã‹ã‚‰å‰Šé™¤");
        }

        localStorage.removeItem("currentRoom");
      } catch (e) {
        console.warn("âš ï¸ visibilitychangeå‰Šé™¤å¤±æ•—:", e);
      }
    }

    // è‡ªå‹•ã§ index.html ã«æˆ»ã‚‹
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  }
});


const joinUI = document.getElementById("join-ui");
const submitJoin = document.getElementById("submit-join");
const errorDisplay = document.getElementById("join-error");
const errorSound = document.getElementById("error-sound");

joinButton.addEventListener("click", () => {
  joinUI.style.display = "block";
    button.style.pointerEvents = "none";
  button.style.opacity = 0.5;
    const joinBtn = document.getElementById("join-room-button");
  

  joinBtn.style.pointerEvents = "none";
  joinBtn.style.opacity = 0.5;

});

submitJoin.addEventListener("click", async () => {
    const requestedRoom = document.getElementById("join-room-number").value;


  const roomNumber = document.getElementById("join-room-number").value;
  if (!roomNumber) return;

    // ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ â†’ ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦ç™»éŒ²
  const playerName = localStorage.getItem("playerName");
  const userId = localStorage.getItem("userId");

  await set(ref(db, `rooms/${roomNumber}/members/${playerName}`), {
    userId,
    joinedAt: Date.now()
  });



  alert(`âœ… ãƒ«ãƒ¼ãƒ  ${roomNumber} ã«å‚åŠ ã—ã¾ã—ãŸï¼`);

  // âœ… å‚åŠ å®Œäº†å¾Œã«ãƒ•ãƒ¬ãƒ¼ãƒ æƒ…å ±ã‚’æ›´æ–°
  const roomRef = ref(db, `rooms/${roomNumber}`);
  const snapshot = await get(roomRef);
  if (!snapshot.exists()) {
  errorDisplay.style.display = "block";
  errorDisplay.style.opacity = "1";
  errorSound.play();
  setTimeout(() => (errorDisplay.style.opacity = "0"), 1000);
  setTimeout(() => (errorDisplay.style.display = "none"), 2500);
  return;
}

if (snapshot.val().info.host === playerName) {
  alert("âš ï¸ è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã«ã¯å‚åŠ ã§ãã¾ã›ã‚“ï¼");
  return;
}

  if (snapshot.exists()) {
    const data = snapshot.val();
    const info = data.info;
    const members = data.members || {};
    const display =
      `ä¸»å‚¬è€…: ${info?.host || "???"}\n` +
      `ç•ªå·: ${roomNumber}\n` +
      `ãƒ¡ãƒ³ãƒãƒ¼:\n` +
      Object.keys(members)
        .map(name => `ãƒ»${name}`)
        .join("\n");

    const infoBox = document.getElementById("room-info");
    if (infoBox) {
      infoBox.innerText = display;
    }
  }


// ä¸»å‚¬è€…ãŒãƒ«ãƒ¼ãƒ ã‚’æ¶ˆã—ãŸã‹ã©ã†ã‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
const watchRef = ref(db, `rooms/${roomNumber}`);
onValue(watchRef, (snapshot) => {
  if (!snapshot.exists()) {
    const errBox = document.getElementById("join-error");
    errBox.textContent = "ä¸»å‚¬è€…ãŒè§£æ•£ã—ã¾ã—ãŸ";
    errBox.style.display = "block";
    errBox.style.color = "red";
    errBox.style.opacity = "1";

    const errorSound = document.getElementById("error-sound");
    if (errorSound) errorSound.play();

    setTimeout(() => {
      errBox.style.opacity = "0";
    }, 1000);

    setTimeout(() => {
      errBox.style.display = "none";
      localStorage.removeItem("currentRoom");
      window.location.href = "index.html";
    }, 2500);
  }
});

});
// âœ… ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
function startRoomInfoListener(roomNumber) {
  const infoBox = document.getElementById("room-info");
  const roomRef = ref(db, `rooms/${roomNumber}`);
  onValue(roomRef, (snapshot) => {
    if (!snapshot.exists()) return;

    const data = snapshot.val();
    const info = data.info;
    const members = data.members || {};
    const display =
      `ä¸»å‚¬è€…: ${info?.host || "???"}\n` +
      `ç•ªå·: ${roomNumber}\n` +
      `ãƒ¡ãƒ³ãƒãƒ¼:\n` +
      Object.keys(members).map(name => `ãƒ»${name}`).join("\n");

    if (infoBox) infoBox.innerText = display;
  });
}
async function handleLeaveRoom() {
  const currentRoom = localStorage.getItem("currentRoom");
  const playerName = localStorage.getItem("playerName");
  const userId = localStorage.getItem("userId");

  if (!currentRoom || !playerName) {
    console.warn("âš ï¸ currentRoom ã‹ playerName ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  const roomRef = ref(db, `rooms/${currentRoom}`);
  try {
    const snapshot = await get(roomRef);

    if (!snapshot.exists()) {
      console.warn("âš ï¸ ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
      return;
    }

    const isHost = snapshot.val()?.info?.host === playerName;

    if (isHost) {
      console.log("ğŸ§¹ ä¸»å‚¬è€…ã¨ã—ã¦ãƒ«ãƒ¼ãƒ å…¨å‰Šé™¤");
      await remove(roomRef);
    } else {
      console.log("ğŸ§¹ å‚åŠ è€…ã¨ã—ã¦ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰å‰Šé™¤");
      await remove(ref(db, `rooms/${currentRoom}/members/${playerName}`));
    }

    localStorage.removeItem("currentRoom");

  } catch (e) {
    console.error("âŒ handleLeaveRoom ã‚¨ãƒ©ãƒ¼:", e);
  }
}


window.addEventListener("beforeunload", async (e) => {
  e.preventDefault();
  await handleLeaveRoom(); // ğŸ” ç¢ºå®Ÿã« await
});

document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "hidden") {
    await handleLeaveRoom(); // ğŸ” visibilitychangeã§ã‚‚çµ±ä¸€

    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  }
});


</script>


  <!-- âœ… script ã¯ä¸€ç•ªæœ€å¾Œ -->
  <script src="scene2.js"></script>
  <script src="locks.js"></script>

</body>
</html>
